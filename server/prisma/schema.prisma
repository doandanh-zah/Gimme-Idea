generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  username          String    @unique
  password          String
  emailVerified     Boolean   @default(false)
  emailVerifyToken  String?
  avatar            String?
  bio               String?   @db.Text
  walletAddress     String?   @unique
  walletType        String?
  walletConnectedAt DateTime?
  aiCredits         Int       @default(5)
  reputation        Int       @default(0)
  totalTipsReceived Float     @default(0)
  totalTipsGiven    Float     @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  projects          Project[]
  feedbacks         Feedback[]
  aiChats           AIChat[]
  tipsGiven         Tip[]     @relation("TipSender")
  tipsReceived      Tip[]     @relation("TipReceiver")
  notifications     Notification[]

  @@index([email])
  @@index([walletAddress])
  @@index([username])
}

model Project {
  id             String         @id @default(cuid())
  userId         String
  title          String         @db.VarChar(100)
  description    String         @db.Text
  coverImage     String?
  projectUrl     String?
  repoUrl        String?
  feedbackNeeded String         @db.Text
  category       String
  tags           String[]
  techStack      String[]
  aiReview       Json?
  aiScore        Int?
  aiReviewedAt   DateTime?
  status         ProjectStatus  @default(DRAFT)
  viewCount      Int            @default(0)
  feedbackCount  Int            @default(0)
  uniqueViewers  String[]       @default([])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  publishedAt    DateTime?
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedbacks      Feedback[]
  aiChats        AIChat[]

  @@index([userId, status])
  @@index([category])
  @@index([aiScore])
}

model Feedback {
  id        String     @id @default(cuid())
  projectId String
  userId    String
  content   String     @db.Text
  isAI      Boolean    @default(false)
  parentId  String?
  helpful   Int        @default(0)
  reactions Json?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id])
  tips      Tip[]
  parent    Feedback?  @relation("FeedbackReplies", fields: [parentId], references: [id])
  replies   Feedback[] @relation("FeedbackReplies")

  @@index([projectId])
  @@index([userId])
  @@index([parentId])
}

model AIChat {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  message   String   @db.Text
  response  String   @db.Text
  tokenUsed Int
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([projectId, userId])
}

model Tip {
  id          String    @id @default(cuid())
  fromUserId  String
  toUserId    String
  feedbackId  String
  amount      Float
  usdValue    Float?
  signature   String    @unique
  status      TipStatus @default(PENDING)
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  sender      User      @relation("TipSender", fields: [fromUserId], references: [id])
  receiver    User      @relation("TipReceiver", fields: [toUserId], references: [id])
  feedback    Feedback  @relation(fields: [feedbackId], references: [id])

  @@index([fromUserId])
  @@index([toUserId])
  @@index([signature])
}

model Notification {
  id      String            @id @default(cuid())
  userId  String
  type    NotificationType
  title   String
  message String
  data    Json?
  read    Boolean           @default(false)
  readAt  DateTime?
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

enum ProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TipStatus {
  PENDING
  COMPLETED
  FAILED
}

enum NotificationType {
  FEEDBACK_RECEIVED
  TIP_RECEIVED
  PROJECT_REVIEWED
  AI_CREDITS_LOW
  WALLET_CONNECTED
}
